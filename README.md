# Go-Authについて
本システムでは共通の認証とユーザー情報を管理する\
認証はOAuthのプロセスをもとに実施している

今後はログイン画面(Go-Auth-UI)を作成してそこを通して他システムの認証をおこなえるようにする

# go-authのプロセス

トークン名(論理名)|トークン名(物理名)|有効期限|格納場所
-|-|-|-
認可コード|-|30 sec|キャッシュ
アクセストークン|-|1800 sec|キャッシュ? DB?


1. Go-Authのログイン画面を表示\
  この際セットで認可ID取得のためのパスフレーズも要求し、クエリパラメータでセットで覚えておく（認可IDの有効期限は一旦未設定とする）\
  送信されたユーザID（またはメールアドレス）とパスワード、ストアで持ったセッションIDをチェック

1. 1.で問題なければユーザIDとトークンを紐づけ、認可IDを送信する\
  この際トークンの有効期限は30分、認可IDの有効期限は30秒で設定

1. 外部システムから認可IDとパスフレーズを受け取り、認可IDの有効期限内であればトークンIDを返す\
この際認可IDの使用済フラグとトークンIDを有効にする

1. 


# キャッシュ
認可IDやログインプロセスのID保持のためキャッシュを利用

キャッシュはGo用のキャッシュ[bigcache](https://github.com/allegro/bigcache)の利用を検討

+ 大量のリクエストを拘束に処理\
  => 他システムからのログインプロセスでアクセスが集中するのが想定されるため
+

参考：[go-cacheでキャッシュを実装する](https://zenn.dev/kimd/articles/4bc261c74d4545)

# go-auth-db DDL
### テーブル一覧
以下に本システムで扱うDDLを載せる

1. **ユーザ認証情報管理テーブル**

論理名|物理名|型|必須|桁数|備考||
-|-|-|-|-|-|-|
ユーザID|user_id|文字列|○|50|主キー・外部キー
パスワード|password|文字列|○|60||
パスワード履歴1|password_histry1|文字列|-|60||
パスワード履歴2|password_histry2|文字列|-|60||
パスワード履歴3|password_histry3|文字列|-|60||
パスワード誤入力回数|password_fail_cnt|整数|○|1|デフォルト0
パスワードロック|password_lock|整数|○|1|デフォルト0

2. **ユーザ付加情報管理テーブル**

論理名|物理名|型|必須|備考||
-|-|-|-|-|-
ユーザID|user_id|文字列|○|主キー・外部キー
ユーザ名|user_name|文字列|○|
メールアドレス|email|文字列|-|
電話番号|phone|数値|-|
性別|gender|文字列|-|

3. **トークンID管理テーブル**

論理名|物理名|型|必須|備考||
-|-|-|-|-|-
トークンID|token_id|文字列|○|主キー
認可ID|auth_id|文字列|
有効期限|expire|日時|-
有効フラグ|enable_flag|整数|○|デフォルト0


2. **認可ID発行管理テーブル**

論理名|物理名|型|必須|備考||
-|-|-|-|-|-
セッションID|session_id|文字列|○|主キー・ログイン画面との通信セッションで使用
認可ID|auth_id|文字列|○|
パスフレーズ|pass_frase|文字列|○|認可コード照合時にセットでチェック
有効期限|expire|日時|-
認可ID発行済フラグ|send_flag|整数|○|デフォルト 0


3. **ログインユーザー情報管理テーブル**

論理名|物理名|型|必須|備考||
-|-|-|-|-|-
ユーザID|user_id|文字列|○|主キー・外部キー
トークン|token|文字列|○|外部キー
セッションID|session_id|文字列|○|外部キー