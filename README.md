# Go-Authについて
本システムでは共通の認証とユーザー情報を管理する\
認証はOAuthのプロセスをもとに実施している

今後はログイン画面(Go-Auth-UI)を作成してそこを通して他システムの認証をおこなえるようにする

OAuth2.0 Authrization Code Grant(認可コードグラント)の要件で作成される

# go-authのプロセス

トークン名(論理名)|トークン名(物理名)|有効期限|格納場所
-|-|-|-
認可コード|-|30 sec|キャッシュ
アクセストークン|-|1800 sec|キャッシュ? DB?


1. Go-Authのログイン画面を表示\
  この際セットで認可ID取得のためのパスフレーズも要求し、クエリパラメータでセットで覚えておく（認可IDの有効期限は一旦未設定とする）\
  送信されたユーザID（またはメールアドレス）とパスワード、ストアで持ったセッションIDをチェック

1. 1.で問題なければユーザIDとトークンを紐づけ、認可IDを送信する\
  この際トークンの有効期限は30分、認可IDの有効期限は30秒で設定

1. 外部システムから認可IDとパスフレーズを受け取り、認可IDの有効期限内であればトークンIDを返す\
この際認可IDの使用済フラグとトークンIDを有効にする

1. 

# Go-Authでの要件
+ Goを使ってバックエンドと認証周りの勉強（開発者個人の学習向け）
+ 今後、別システムの認証としても使えるように接続先システムを管理できるようにする
+ セキュリティについてはしっかりと考えて、可能な範囲(無料ツールでの診断を活用するなど)で脆弱性を無くす


# Go-Authで提供されるAPI
### 一覧
25/8月時点  prototype版

ID |論理名 |エンドポイント |HTTPメソッド
---|------|--------------|------------
GAAPI00000|認可ID要求API                |/api/v1/permission   |GET
GAAPI00001|ログインAPI                  |/api/v1/login        |POST
---|---|---|---|
GAAPI10000|アクセストークン要求API       |/api/v1/token/create |POST
GAPI100001|アクセストークン有効チェックAPI|/api/v1/token/check  |GET
GAAPI10002|アクセストークン削除API       |/api/v1/token/delete |DELETE
---|---|---|---|
GAAPI20000|ユーザ登録API                |/api/v1/user/create  |POST
GAAPI20001|ユーザ情報照会API            |/api/v1/user/inquiry |GET


+ ユーザ情報更新API
+ ユーザ削除API


* ### 認可ID要求
go-auth内で「アクセストークン発行」の際に用いる認可IDを発行する\
認証の際はログイン画面を表示し、内部で認証問題なければ認可IDを返却し、

**Request**
論理名|物理名|必須|型|長さ|備考|
-|-|-|-|-|-|
要求コード||〇|文字列|5|後の「ユーザ情報照会」にて取得する情報
リダイレクトURI||〇|文字列|1024|OK時のリダイレクト先

**Responce**
論理名|物理名|必須|型|長さ|備考|
-|-|-|-|-|-|
認可ID||〇|文字列|256|後の「アクセストークン発行」にて使用する認可ID|


* ### アクセストークン発行

**Request**
論理名|物理名|必須|型|長さ|備考|
-|-|-|-|-|-|
要求コード||〇|文字列|5|
リダイレクトURI||〇|文字列|1024|
認可ID||〇|文字列|256|

**Responce**
論理名|物理名|必須|型|長さ|備考|
-|-|-|-|-|-|
アクセストークン||〇|文字列|256|

* ### アクセストークン有効チェック
これで片っ端から試されてヒットされるといけないので複数の情報を載せてヒットしにくくする + 連続誤りで対象のアクセストークンを無効とする\
**Request**
論理名|物理名|必須|型|長さ|備考|
-|-|-|-|-|-|
要求コード||〇|文字列|5|
リダイレクトURI||〇|文字列|1024|
認可ID||〇|文字列|256|
アクセストークン||〇|文字列|256|

**Request**
論理名|物理名|必須|型|長さ|備考|
-|-|-|-|-|-|
有効フラグ||〇|文字列|256|
詳細情報||〇|文字列|256|


* ### ユーザ情報照会
* ### ユーザ情報更新


# キャッシュ
認可IDやログインプロセスのID保持のためキャッシュを利用

~~ キャッシュはGo用のキャッシュ[bigcache](https://github.com/allegro/bigcache)の利用を検討 ~~

+ 大量のリクエストを拘束に処理\
  => 他システムからのログインプロセスでアクセスが集中するのが想定されるため

個別でアイテムの期限(TTL)設けられないためbigcacheは断念（画面表示用のデータなど）\
=> [ristretto](https://github.com/dgraph-io/ristretto)に変更
+ 大量リクエストを高速に処理できる
+ 高度なメモリ管理機能を持つ


参考：[go-cacheでキャッシュを実装する](https://zenn.dev/kimd/articles/4bc261c74d4545)

### キャッシュ一覧
key(論理名)|value(論理名)|型(value)|保持期間 [sec] |備考|
-|-|-|-|-|
認可ID|リダイレクトURI(その他値), 使用済フラグ|構造体|30|
アクセストークン|有効フラグ(その他値)|文字列|1800 (30min × 60sec)||

# go-auth-db DDL

### テーブル一覧
以下に本システムで扱うDDLを載せる

1. **ユーザ認証情報管理テーブル**

論理名|物理名|型|必須|桁数|備考||
-|-|-|-|-|-|-|
ユーザID|user_id|文字列|○|50|主キー・外部キー
パスワード|password|文字列|○|60||
パスワード履歴1|password_histry1|文字列|-|60||
パスワード履歴2|password_histry2|文字列|-|60||
パスワード履歴3|password_histry3|文字列|-|60||
パスワード誤入力回数|password_fail_cnt|整数|○|1|デフォルト0
パスワードロック|password_lock|整数|○|1|デフォルト0

2. **ユーザ付加情報管理テーブル**

論理名|物理名|型|必須|備考||
-|-|-|-|-|-
ユーザID|user_id|文字列|○|主キー・外部キー
ユーザ名|user_name|文字列|○|
メールアドレス|email|文字列|-|
電話番号|phone|数値|-|
性別|gender|文字列|-|

3. **トークンID管理テーブル**

論理名|物理名|型|必須|備考||
-|-|-|-|-|-
トークンID|token_id|文字列|○|主キー
認可ID|auth_id|文字列|
有効期限|expire|日時|-
有効フラグ|enable_flag|整数|○|デフォルト0


2. **認可ID発行管理テーブル**

論理名|物理名|型|必須|備考||
-|-|-|-|-|-
セッションID|session_id|文字列|○|主キー・ログイン画面との通信セッションで使用
認可ID|auth_id|文字列|○|
パスフレーズ|pass_frase|文字列|○|認可コード照合時にセットでチェック
有効期限|expire|日時|-
認可ID発行済フラグ|send_flag|整数|○|デフォルト 0


3. **ログインユーザー情報管理テーブル**

論理名|物理名|型|必須|備考||
-|-|-|-|-|-
ユーザID|user_id|文字列|○|主キー・外部キー
トークン|token|文字列|○|外部キー
セッションID|session_id|文字列|○|外部キー